<html>
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <title>Milk Playground</title>
    <script type="text/javascript" charset="utf-8" src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
    <script type="text/javascript" charset="utf-8" src="http://methvin.com/splitter/splitter.js"></script>
    <script type="text/javascript" charset="utf-8" src="http://coffeescript.org/v1/browser-compiler/coffee-script.js"></script>
    <script type="text/javascript" charset="utf-8" src="./milk.js"></script>
    <link rel="stylesheet" href="playground.css" type="text/css" media="screen" charset="utf-8">
  </head>
  <body onload="render()">
    <h1><span></span>{{! Mustache Playground }}</h1>
    <div id="split-vertical">
      <div id="split-lateral">
        <div style="height: 35%">
          <div class="name">Data</div>
          <textarea onkeyup="render()" id="data"></textarea>
          <div id='data-err' class="error"></div>
        </div>
        <div>
          <div class="name">Template</div>
          <textarea onkeyup="render()" id="tmpl"></textarea>
          <div id='tmpl-err' class="error"></div>
        </div>
      </div>
      <div>
        <div class="name">Result</div>
        <div id="result" name="result"></div>
        <div class="permalink"><a id="link" href="">Permalink</a></div>
      </div>
    </div>
    <script type="text/coffeescript" charset="utf-8">
      $("#split-lateral").splitter({ type: 'h', minTop: 100, minBottom: 100, sizeTop: true })
      $("#split-vertical").splitter({ type: 'v', minLeft: 200, minRight: 200, sizeRight: 350, anchorToWindow: true })

      result  = $('#result')
      data    = $('#data')
      tmpl    = $('#tmpl')
      dataErr = $('#data-err')
      tmplErr = $('#tmpl-err')
      link    = $('#link')

      if location.getParameter
        data.val decodeURIComponent location.getParameter('data')
        tmpl.val decodeURIComponent location.getParameter('tmpl')
      else if location.search
        data.val decodeURIComponent(location.search.match(/data=(.*?)(?:&|$)/)[1] || '')
        tmpl.val decodeURIComponent(location.search.match(/tmpl=(.*?)(?:&|$)/)[1] || '')

      data.val data.val() || '''
        header: "Colors"
        list: [
          { name: "red",   url: "#Red",   current: yes }
          { name: "green", url: "#Green", current: no  }
          { name: "blue",  url: "#Blue",  current: no  }
        ]
      '''

      tmpl.val tmpl.val() || '''
        <h1>{{header}}</h1>

        {{#list.length}}
        <ul>
        {{#list}}
        {{#current}}
        <li><strong>{{name}}</strong></li>
        {{/current}}
        {{^current}}
        <li>a href="{{url}}">{{name}}</a></li>
        {{/current}}
        {{/list}}
        </ul>
        {{/list.length}}
        {{^list.length}}
        <p>The list is empty.</p>
        {{/list.length}}
      '''

      @render = ->
        T = tmpl.val()

        link.attr href: location.pathname + '?' +
          'data=' + encodeURIComponent(data.val()) + '&' +
          'tmpl=' + encodeURIComponent(tmpl.val())

        try
          D = data.val() || '{}'
          D = CoffeeScript.eval D
          dataErr.hide()
        catch e
          dataErr.html("#{e}")
          dataErr.show()

        try
          result.text(Milk.render(T, D))
          tmplErr.hide()
        catch e
          tmplErr.html("Line #{e.line}, column #{e.char}: #{e.error}")
          tmplErr.show()
    </script>
  </body>
</html>
